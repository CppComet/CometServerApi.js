function getCookie(name){var cookie=" "+document.cookie;var search=" "+name+"=";var setStr=null;var offset=0;var end=0;if(cookie.length>0){offset=cookie.indexOf(search);if(offset!=-1){offset+=search.length;end=cookie.indexOf(";",offset);if(end==-1)end=cookie.length;setStr=unescape(cookie.substring(offset,end))}}return setStr}
function base64_decode(data){var b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var o1,o2,o3,h1,h2,h3,h4,bits,i=0,enc="";do{h1=b64.indexOf(data.charAt(i++));h2=b64.indexOf(data.charAt(i++));h3=b64.indexOf(data.charAt(i++));h4=b64.indexOf(data.charAt(i++));bits=h1<<18|h2<<12|h3<<6|h4;o1=bits>>16&255;o2=bits>>8&255;o3=bits&255;if(h3==64)enc+=String.fromCharCode(o1);else if(h4==64)enc+=String.fromCharCode(o1,o2);else enc+=String.fromCharCode(o1,o2,o3)}while(i<data.length);return utf8(enc)}
function comet_server_signal(){if(!this.custom_id){this.custom_id=Math.random()+"_"+Math.random()+"_"+Math.random()+"_"+Math.random();this.slotArray=new Array;this.debug=false}if(this.init===undefined)this.init=false;this.connect=function(slot_name,signal_name,slot_function){if(slot_function===undefined){slot_function=signal_name;signal_name=slot_name;slot_name=Math.random()+""+Math.random()}if(this.slotArray[signal_name]===undefined)this.slotArray[signal_name]=new Array;this.slotArray[signal_name][slot_name]=
slot_function;if(this.debug)console.log("\u041d\u0430 \u043f\u0440\u043e\u0441\u043b\u0443\u0448\u0438\u0432\u0430\u043d\u0438\u0435 \u0441\u0438\u0433\u043d\u0430\u043b\u0430 "+signal_name+" \u0434\u043e\u0431\u0430\u0432\u043b\u0435\u043d \u0441\u043b\u043e\u0442 "+slot_name+"");return slot_name};this.disconnect=function(slot_name,signal_name){if(this.slotArray[signal_name]===undefined)this.slotArray[signal_name]=new Array;if(this.slotArray[signal_name][slot_name]!==undefined)delete this.slotArray[signal_name][slot_name]};
this.emit=function(signal_name,param){if(this.slotArray[signal_name]===undefined){if(this.debug)console.log("\u041d\u0430 \u0441\u0438\u0433\u043d\u0430\u043b "+signal_name+" \u043d\u0435\u0442 \u043f\u043e\u0434\u043f\u0438\u0441\u0447\u0438\u043a\u043e\u0432")}else{if(this.debug)console.log("\u0421\u0438\u0433\u043d\u0430\u043b "+signal_name+" \u043f\u043e\u0434\u043f\u0438\u0441\u0430\u043d\u044b \u0441\u043b\u043e\u0442\u044b");for(var slot in this.slotArray[signal_name])this.slotArray[signal_name][slot](param,
signal_name)}};this.send_emit=function(signal_name,param){this.emit(signal_name,param);if(window["localStorage"]!==undefined){var curent_custom_id=Math.random()+"_"+Math.random()+"_"+Math.random()+"_"+Math.random()+"_"+Math.random();last_custom_id=curent_custom_id.replace(/0\./img,"");window["localStorage"]["comet_server_signal_storage_emit"]=JSON.stringify({name:signal_name,custom_id:curent_custom_id,param:param})}};return this}
function storageEventHandler(e){var data=JSON.parse(e.newValue);if(this.debug)console.log(data.name);comet_server_signal().emit(data.name,data.param)}if(!comet_server_signal.prototype.init){comet_server_signal.prototype.init=true;if(window.addEventListener)window.addEventListener("storage",storageEventHandler,false);else document.attachEvent("onstorage",storageEventHandler)}
function CometServer(options){console.log(options);var CometServerApi=function(opt){this.options=opt;this.arg="";this.url="//client"+this.options.dev_id+".comet-server.ru:44442/?type=Long-Polling&sesion="+this.options.user_key+"&myid="+this.options.user_id+"&devid="+this.options.dev_id;this.subscription_array=new Array;this.user_id=0;this.custom_id=Math.random()+""+Math.random();console.log([this.custom_id,opt]);this.time_to_reconect_on_error=1E3;this.in_abort=false;this.restart_time_id=false;this.start_timer=
3E3;this.subscription=function(name){if(name!==undefined&&name.length>2){for(var i in this.subscription_array)if(this.subscription_array[i]===name)return 1;this.subscription_array[this.subscription_array.length]=name;if(this.is_master){console.log("add subscription:"+name);this.restart()}else{console.log("send_emit:comet_msg_slave_add_subscription_and_restart:"+name);comet_server_signal().send_emit("comet_msg_slave_add_subscription_and_restart",name)}}};this.start=function(callback){this.in_abort=
false;this.conect(callback)};this.stop=function(){if(this.is_master){this.in_abort=true;this.xhrObj.abort()}else comet_server_signal().send_emit("comet_msg_slave_signal_stop")};this.restart=function(callback,callback_arg){var thisObj=this;if(this.is_master){if(this.restart_time_id!==false)clearTimeout(this.restart_time_id);this.restart_time_id=setTimeout(function(){thisObj.in_abort=true;thisObj.xhrObj.abort();thisObj.in_abort=false;thisObj.conect_to_server(callback,callback_arg);console.error("msg master restart")},
1E3)}else{console.error("comet_msg_slave_signal_restart");comet_server_signal().send_emit("comet_msg_slave_signal_restart")}};this.setAsMaster=function(){var thisObj=this;this.is_master=true;comet_server_signal().send_emit("comet_msg_master_signal");comet_server_signal().send_emit("comet_msg_new_master");setInterval(function(){comet_server_signal().send_emit("comet_msg_master_signal")},this.start_timer/3);comet_server_signal().connect(false,"comet_msg_slave_signal_restart",function(p,arg){console.log([p1,
arg]);thisObj.restart()});comet_server_signal().connect(false,"comet_msg_slave_signal_stop",function(p,arg){console.log([p1,arg]);thisObj.stop()});comet_server_signal().connect(false,"comet_msg_slave_add_subscription_and_restart",function(p1,arg){console.log([p1,arg]);thisObj.subscription(arg[1][1]);thisObj.restart()})};this.conect_to_server=function(){var thisObj=this;if(!this.is_master)this.setAsMaster();console.log("\u0421\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u0435 \u0441 \u0441\u0435\u0440\u0432\u0435\u0440\u043e\u043c");
try{this.request=new XMLHttpRequest}catch(trymicrosoft){try{this.request=new ActiveXObject("Msxml2.XMLHTTP")}catch(othermicrosoft){try{this.request=new ActiveXObject("Microsoft.XMLHTTP")}catch(failed){this.request=false}}}this.request.onreadystatechange=function(){if(thisObj.request.readyState!==4)return;if(thisObj.request.status===200){var re=thisObj.request.responseText;console.log("\u0412\u0445\u043e\u0434\u044f\u0449\u0438\u0435 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435:"+re);var lineArray=
re.replace(/^\s+|\s+$/,"").split("\n");for(var i in lineArray){var rj=JSON.parese(lineArray[i]);rj=rj[0];console.log(rj);if(thisObj.in_abort===true&&rj===undefined)return false;else if(rj===undefined){console.log("\u041e\u0448\u0438\u0431\u043a\u0430 \u0432 xhr, \u043f\u0435\u0440\u0435\u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435 \u0447\u0435\u0440\u0435\u0437 "+thisObj.time_to_reconect_on_error+" \u0441\u0435\u043a\u0443\u043d\u0434\u044b.");setTimeout(function(){thisObj.conect_to_server()},
thisObj.time_to_reconect_on_error);return false}if(rj.event===0&&rj.msg!==undefined){rj.msg=base64_decode(rj.msg);rj.msg=eval("["+rj.msg+"]");rj.msg=rj.msg[0];comet_server_signal().send_emit("server_msg",rj.msg);if(rj.msg.name!==undefined)comet_server_signal().send_emit("server_comet_msg_"+rj.msg.name,rj.msg)}comet_server_signal().send_emit("server_event",rj)}thisObj.conect_to_server()}else{console.log("\u041e\u0448\u0438\u0431\u043a\u0430 \u0432 xhr, \u043f\u0435\u0440\u0435\u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435 \u0447\u0435\u0440\u0435\u0437 "+
thisObj.time_to_reconect_on_error+" \u0441\u0435\u043a\u0443\u043d\u0434\u044b.");setTimeout(function(){thisObj.conect_to_server()},thisObj.time_to_reconect_on_error)}};this.request.open("POST",this.url,true);this.request.send(this.subscription_array.join("\n"))};this.is_master=false;this.conect=function(callback){if(callback===undefined)callback=function(){};var thisObj=this;console.log("\u041f\u043e\u043f\u044b\u0434\u043a\u0430 \u0441\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u044f \u0441 \u0441\u0435\u0440\u0432\u0435\u0440\u043e\u043c");
var time_id=setTimeout(function(){comet_server_signal().disconnect("comet_msg_conect","comet_msg_master_signal");thisObj.conect_to_server();callback()},thisObj.start_timer);var last_timeout_id=false;comet_server_signal().connect("comet_msg_conect","comet_msg_master_signal",function(){if(time_id!==false){clearTimeout(time_id);time_id=false;console.log("\u0421\u043e\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u0435 \u0441 \u0441\u0435\u0440\u0432\u0435\u0440\u043e\u043c \u043e\u0442\u043c\u0435\u043d\u0435\u043d\u043e")}else{if(last_timeout_id!==
false){clearTimeout(last_timeout_id);last_timeout_id=false}last_timeout_id=setTimeout(function(){comet_server_signal().disconnect("comet_msg_master_signal");thisObj.conect_to_server()},thisObj.start_timer)}})}};if(options===undefined)options={};this.options=options;if(!this.options.CookieKyeName)this.options.CookieKyeName="CometUserKey";if(!this.options.CookieIdName)this.options.CookieIdName="CometUserid";if(!this.options.user_key)this.options.user_key=getCookie(this.options.CookieKyeName);if(!this.options.user_id)this.options.user_id=
getCookie(this.options.CometUserid);if(!this.options.dev_id)console.error("CometServerApi:\u041d\u0435 \u0443\u043a\u0430\u0437\u0430\u043d dev_id");if(!this.server)this.server=new CometServerApi(this.options);return this.server}$(document).ready(function(){CometServer({dev_id:5}).start()});
